/* Apps Script: 商品マスタ API for 発注表
   - シート名: "商品マスタ" を想定
   - 公開 (web app) としてデプロイして使います
   - 書き込み系は password を要求 (Q6→A)
*/

// ----- 設定 -----
const SHEET_NAME = '商品マスタ';        // そのまま使うなら変更不要
const PASSWORD = https://script.google.com/macros/s/AKfycbxQMjdKyE3p-gLAP-P7RMZA8WDyo6hH2RQcFZVbsKuJlX_0malWWWmV1qlCS7S2UAQj/exec; // ← デプロイ前に変更
// -----------------

/**
 * GET: ?action=getProducts
 * POST: body JSON { action: 'add'|'edit'|'delete'|'submitOrder', ... }
 */
function doGet(e){
  const action = (e.parameter.action || 'getProducts');
  if(action === 'getProducts'){
    return ContentService.createTextOutput(JSON.stringify({ ok:true, items: getProducts() }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeader('Access-Control-Allow-Origin','*');
  }
  return ContentService.createTextOutput(JSON.stringify({ ok:false, error:'invalid_action' }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}

function doPost(e){
  // Build JSON from POST body
  let payload = {};
  try{
    payload = JSON.parse(e.postData.contents);
  }catch(err){
    return jsonError('invalid_json');
  }

  const action = payload.action;
  if(!action) return jsonError('no_action');

  // Public actions that don't require password: submitOrder
  if(action === 'submitOrder'){
    return submitOrderToSheet(payload);
  }

  // The rest require password
  if(!payload.password || payload.password !== PASSWORD){
    return jsonError('auth_failed');
  }

  try{
    if(action === 'add'){
      return addProduct(payload);
    } else if(action === 'edit'){
      return editProduct(payload);
    } else if(action === 'delete'){
      return deleteProduct(payload);
    } else if(action === 'getProducts'){
      return ContentService.createTextOutput(JSON.stringify({ ok:true, items: getProducts() }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeader('Access-Control-Allow-Origin','*');
    } else {
      return jsonError('unknown_action');
    }
  }catch(err){
    return jsonError('server_error', err.toString());
  }
}

/* ---------- ユーティリティ ---------- */
function jsonError(code, msg){
  const payload = { ok:false, error:code, message: msg||'' };
  return ContentService.createTextOutput(JSON.stringify(payload))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}

// 既存シートを読み取って items 配列を返す
function getProducts(){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_NAME);
  if(!sh) return [];
  const values = sh.getDataRange().getValues();
  if(values.length <= 1) return []; // ヘッダーのみ
  const header = values[0].map(h=>String(h || '').trim());
  const rows = values.slice(1);
  const items = rows.map((r, idx) => {
    const obj = {};
    header.forEach((col, i) => {
      obj[col] = r[i];
    });
    // 安全のため型調整
    return {
      _rowIndex: idx + 2, // シート上の行番号（2行目からデータ）
      origin: String(obj['産地'] || ''),
      name: String(obj['商品名'] || ''),
      spec: String(obj['規格'] || ''),   // 新フィールド
      pack: Number(obj['入り数'] || 1),
      price: Number(obj['単価'] || 0),
      note: String(obj['メモ'] || '')
    };
  });
  return items;
}

/* 追加 */
function addProduct(payload){
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sh = ss.getSheetByName(SHEET_NAME);
  if(!sh){
    // ヘッダー作成
    sh = ss.insertSheet(SHEET_NAME);
    sh.appendRow(['産地','商品名','規格','入り数','単価','メモ']);
  }
  const origin = payload.origin || '';
  const name = payload.name || '';
  const spec = payload.spec || '';
  const pack = Number(payload.pack) || 1;
  const price = Number(payload.price) || 0;
  const note = payload.note || '';

  sh.appendRow([origin, name, spec, pack, price, note]);

  return ContentService.createTextOutput(JSON.stringify({ ok:true }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}

/* 編集 - payload に _rowIndex を添えて送る（do not trust client indices in hostile setups） */
function editProduct(payload){
  const rowIndex = Number(payload._rowIndex);
  if(!rowIndex || rowIndex < 2) return jsonError('invalid_row');

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_NAME);
  if(!sh) return jsonError('no_sheet');

  const origin = payload.origin || '';
  const name = payload.name || '';
  const spec = payload.spec || '';
  const pack = Number(payload.pack) || 1;
  const price = Number(payload.price) || 0;
  const note = payload.note || '';

  sh.getRange(rowIndex, 1, 1, 6).setValues([[origin, name, spec, pack, price, note]]);

  return ContentService.createTextOutput(JSON.stringify({ ok:true }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}

/* 削除 - 指定の行を削除 */
function deleteProduct(payload){
  const rowIndex = Number(payload._rowIndex);
  if(!rowIndex || rowIndex < 2) return jsonError('invalid_row');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_NAME);
  if(!sh) return jsonError('no_sheet');
  sh.deleteRow(rowIndex);
  return ContentService.createTextOutput(JSON.stringify({ ok:true }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}

/* 注文を既存シートに保存する（例: '注文履歴' シートへ）*/
function submitOrderToSheet(payload){
  // payload: { action:'submitOrder', userNumber, userName, items:[{name,qty,subtotal,...}], total }
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sh = ss.getSheetByName('注文履歴');
  if(!sh){
    sh = ss.insertSheet('注文履歴');
    sh.appendRow(['タイムスタンプ','番号','名前','合計','詳細(JSON)']);
  }
  const ts = new Date();
  const userNumber = payload.userNumber || '';
  const userName = payload.userName || '';
  const total = Number(payload.total) || 0;
  const details = JSON.stringify(payload.items || []);

  sh.appendRow([ts, userNumber, userName, total, details]);

  return ContentService.createTextOutput(JSON.stringify({ ok:true }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeader('Access-Control-Allow-Origin','*');
}
